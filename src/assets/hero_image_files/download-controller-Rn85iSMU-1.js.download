import{a as D}from"./stimulus-helpers-Bg5ApOVk-1.js";import z from"./ez-base-controller-DuL8VR07-1.js";import{a as i}from"./js-Cz0CWeBA-1.js";import{d as c,g as P}from"./download-helpers-DsHHCnqM-1.js";import{g as n,e as w,c as R}from"./ajax-helpers-BQLKOG2a-1.js";import{i as M}from"./flash-helpers-Bnxa3h-n-1.js";import{t as d}from"./helpers-DWGVlOV6-1.js";import{k as g,l as I,m as _,n as U}from"./ez-custom-events-B9oXrnTo-1.js";import f from"./init-user-CLXATX98-1.js";import{r as S,t as p}from"./index-_O8rD79_-1.js";import"./stimulus-Cq41p_up-1.js";import"./index-C4xxlH8f-1.js";import"./_commonjsHelpers-BosuxZz1-1.js";import"./modal_helpers-SODIeXFK-1.js";function b(s,e){return S(2,arguments),p(s).getTime()-p(e).getTime()}var m={ceil:Math.ceil,round:Math.round,floor:Math.floor,trunc:function(s){return s<0?Math.ceil(s):Math.floor(s)}},E="trunc";function B(s){return s?m[s]:m[E]}function A(s,e,o){S(2,arguments);var t=b(s,e)/1e3;return B(o==null?void 0:o.roundingMethod)(t)}const h=class h extends z{constructor(){super(...arguments),this.handleAutoDownload=()=>{this.downloadUrl=this.autoDownloadUrl,this.downloadSize=new URLSearchParams(this.downloadUrl).get("size")||this.downloadSize,i.remove("auto_download_url"),i.remove("download_resource_id"),i.remove("from_successful_checkout"),this.autoDlPathValue=null,!this.dlSizeUserSignedOut&&this.openAdModal(null,!0)},this.handleDownload=async(e=null,o=!1)=>{var t;if(e==null||e.preventDefault(),!this.clickProcessing){if(this.clickProcessing=!0,this.downloadSize=((t=e==null?void 0:e.params)==null?void 0:t.dlSize)||this.downloadSize,this.dlSizeUserSignedOut){this.clickProcessing=!1;return}this.setDownloadUrl(e,o),this.beforeDownload(),this.creditSpent?await this.download():this.download(),this.afterDownload()}},this.handleAutoDownloadEvent=e=>{const o=e,{url:t,resourceId:a}=o.detail||{};t&&(i.set("auto_download_url",t),a&&i.set("download_resource_id",a),this.handleAutoDownload())},this.openAdModal=(e=null,o=!1)=>{var t;if(e==null||e.preventDefault(),!this.hasAdModalPathValue){this.handleDownload(e,o);return}this.downloadSize=((t=e==null?void 0:e.params)==null?void 0:t.dlSize)||this.downloadSize,!this.dlSizeUserSignedOut&&(this.setDownloadUrl(e),window.addEventListener("TriggerDownload",this.handleDownload,{once:!0}),n(this.adModalPathValue))}}connect(){this.setDownloadUrl(),this.downloadSize=null,this.flagLoaded(),this.setDownloadResourceId(),this.autoDownloadUrl&&this.handleAutoDownload(),document.addEventListener("AutoDownload",this.handleAutoDownloadEvent)}disconnect(){window.removeEventListener("TriggerDownload",this.handleDownload),window.removeEventListener("TriggerDownload",this.openAdModal),document.removeEventListener("AutoDownload",this.handleAutoDownloadEvent)}handleDownloadResponse(e){const{url:o,type:t,error:a}=e.data;switch(t){case"download":return c({url:o});case"resize":return this.resizedDownload(o);case"resize_video":return this.resizedVideoDownload(o);case"modal":return n(o);case"redirect":return window.location.href=o,null;case"error":return M({referenceElement:document.querySelector(".ez-page-wrapper"),flashMessageText:a,classes:"ez-flash-message ez-flash-message--error ez-flash-message--flat ez-flash-message--floating ez-flash-message--auto-dismiss",icon:""}),null;default:return null}}resizedDownload(e){this.dispatch("toggleButtonLoading",{detail:{state:"on"}}),w({url:e,pollingNotCompleteCb:o=>{},pollingCompleteCondition:o=>o.data.url!==null,successCb:o=>{this.finishLoadingAndDownload({result:o})},errorCb:()=>{this.dispatch("toggleButtonLoading",{detail:{state:"off"}})},opts:{maxTries:300}})}resizedVideoDownload(e){this.dispatch("toggleButtonLoading",{detail:{state:"on"}}),d(I);const o=Date.now();w({url:e,pollingNotCompleteCb:t=>{d(g,{progress:t.data.progress})},pollingCompleteCondition:t=>t.data.url!==null,successCb:async t=>{d(g,{progress:100}),await this.waitForResizeComplete(o),this.finishLoadingAndDownload({result:t}),d(_)},errorCb:()=>{alert("There was an error resizing this resource."),d(U),this.dispatch("toggleButtonLoading",{detail:{state:"off"}})},opts:{maxTries:300}})}setDownloadUrl(e=null,o=!1){var a,l,r;let t=((a=e==null?void 0:e.currentTarget)==null?void 0:a.href)||this.downloadUrl||this.downloadPathValue;(l=e==null?void 0:e.params)!=null&&l.dlSizeUrl&&(t=(r=e==null?void 0:e.params)==null?void 0:r.dlSizeUrl),o&&(t=this.downloadPathValue),t&&(this.downloadUrl=this.prepareDownloadUrl(t,this.licenseTypeValue,this.downloadSize))}prepareDownloadUrl(e,o=null,t=null){const[a,l]=e.split("?"),r=new URLSearchParams(l);return o&&r.set("license_type",o),t&&r.set("size",t),`${a}?${r.toString()}`}finishLoadingAndDownload({result:e}){const{url:o,filename:t}=e.data,{downloadSize:a}=this;this.dispatch("toggleButtonLoading",{detail:{state:"off"}}),c({url:o,filename:t,downloadSize:a,reloadPage:this.creditSpent})}maybeRedirectInsteadOfDownload(){["join_pro","trial","template"].includes(this.downloadTypeValue)&&(window.location.href=this.downloadUrl)}beforeDownload(){this.maybeRedirectInsteadOfDownload(),this.dispatch("beforeDownload",{detail:{licenseType:this.licenseTypeValue,resourceId:this.resourceIdValue}})}afterDownload(){P({onReload:this.creditSpent}),this.dispatch("afterDownload"),this.creditSpent&&window.setTimeout(()=>{window.location.reload()},1e3),setTimeout(()=>{this.clickProcessing=!1},1e3)}setDownloadResourceId(){if(i.get("download_resource_id"))return;const e=this.resolveResourceId();e&&i.set("download_resource_id",e,{expires:1/24})}resolveResourceId(){return this.hasResourceIdValue?this.resourceIdValue:i.get("download_resource_id")||null}appendResourceIdParam(e){const o=this.resolveResourceId();if(!o)return e;try{const t=new URL(e,window.location.origin);return t.searchParams.set("resource_id",o.toString()),t.pathname+t.search}catch{return e}}appendModalParams(e){let o=this.appendResourceIdParam(e);try{const t=new URL(o,window.location.origin);t.searchParams.get("turbo_frame_id")||t.searchParams.set("turbo_frame_id","download-signup-component"),o=t.pathname+t.search}catch{}return o}download(){return this.downloadTypeValue==="reactivate"?n(this.downloadUrl):R(this.downloadUrl,e=>{this.handleDownloadResponse(e)},e=>{console.error(e)})}lockGridDownloads(){const e=document.querySelector(".ez-resource-grid");e&&(e.classList.add("has-active-download"),this.activeDownloadButton=this.findActiveDownloadButton(e),this.activeDownloadButton&&this.showButtonSpinner(this.activeDownloadButton),this.disableSiblingDownloadButtons(e))}unlockGridDownloads(){const e=document.querySelector(".ez-resource-grid");e&&e.classList.remove("has-active-download"),this.enableSiblingDownloadButtons(),this.hideButtonSpinner()}findActiveDownloadButton(e){return this.autoDownloadResourceId?e.querySelector(`.ez-resource-thumb[data-item-id="${this.autoDownloadResourceId}"] .resource-action-button--download`):null}showButtonSpinner(e){e.classList.add("is-loading"),e.setAttribute("disabled","true"),e.querySelector(".ez-spinner")||e.insertAdjacentHTML("beforeend",'<div class="ez-spinner ez-spinner--sm"></div>')}hideButtonSpinner(){if(!this.activeDownloadButton)return;this.activeDownloadButton.classList.remove("is-loading"),this.activeDownloadButton.removeAttribute("disabled");const e=this.activeDownloadButton.querySelector(".ez-spinner");e==null||e.remove(),this.activeDownloadButton=null}disableSiblingDownloadButtons(e){this.disabledButtons=[],e.querySelectorAll(".resource-action-button--download").forEach(o=>{var t;o!==this.activeDownloadButton&&((t=this.disabledButtons)==null||t.push({button:o,wasDisabled:o.disabled}),o.disabled=!0,o.classList.add("is-disabled"))})}enableSiblingDownloadButtons(){this.disabledButtons&&(this.disabledButtons.forEach(({button:e,wasDisabled:o})=>{o||(e.disabled=!1,e.classList.remove("is-disabled"))}),this.disabledButtons=[])}openReturningSignInModal(e){if(e.preventDefault(),!this.hasReturningSignInModalPathValue)return;i.set("auto_download_url",this.downloadUrl),this.downloadSize=e.params.dlSize,this.setDownloadUrl(e),this.setDownloadResourceId(),window.addEventListener("TriggerDownload",this.openAdModal,{once:!0});const o=this.appendModalParams(this.returningSignInModalPathValue);n(o)}openSignInModal(e){if(e.preventDefault(),!this.hasSignInModalPathValue)return;this.downloadSize=e.params.dlSize,this.setDownloadUrl(e),this.setDownloadResourceId(),i.set("auto_download_url",this.downloadUrl);const o=this.appendModalParams(this.signInModalPathValue);n(o)}openDunningModal(e){e.preventDefault(),this.hasDunningModalPathValue&&n(this.dunningModalPathValue)}spendCreditAndDownload(e=null){e==null||e.preventDefault(),this.creditSpent=!0,this.handleDownload()}openCreditSpendConfirm(e){var o;if(e.preventDefault(),this.downloadSize=((o=e==null?void 0:e.params)==null?void 0:o.dlSize)||this.downloadSize,this.licenseTypeValue!=="pro"||this.creditSpent){this.handleDownload(e);return}this.clickProcessing=!1,this.spendCreditAndDownload()}async waitForResizeComplete(e){const o=f.isPro?2:5;await new Promise(t=>{setInterval(()=>{A(Date.now(),e)>o&&t()},250)})}get autoDownloadUrl(){return i.get("auto_download_url")||this.autoDlPathValue}get dlSizeUserSignedOut(){return this.downloadSize&&this.downloadSize!=="original"&&!f.signedIn}};h.values={adModalPath:String,resizeModalPath:String,resizeWaitingModalPath:String,autoDlPath:String,creditConfirmText:String,downloadPath:String,downloadType:String,downloadUrl:String,dunningModalPath:String,licenseType:String,resourceId:String,returningSignInModalPath:String,signInModalPath:String};let u=h;D({name:"download",import:u});export{u as default};
